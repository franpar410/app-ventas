pipeline {
    agent any

    environment {
        REPORT_DIR = "${WORKSPACE}/reports"
        SAFETY_API_KEY = credentials('safety-api-key') // ID del token en Jenkins Credentials
    }

    stages {

        stage('SCA - Safety Security Scan') {
            steps {
                script {
                    echo "🔍 Ejecutando análisis de dependencias con Safety (Docker + API)..."

                    sh '''
                        set -e
                        mkdir -p ${REPORT_DIR}

                        echo "📦 Lanzando contenedor Python para análisis..."
                        docker run --rm \
                            -e SAFETY_API_KEY=${SAFETY_API_KEY} \
                            -v "$PWD":/app \
                            -w /app \
                            python:3.11-slim bash -c "
                                set -e
                                apt-get update -qq &&
                                apt-get install -y --no-install-recommends gcc libpq-dev jq > /dev/null &&
                                pip install -q safety &&
                                echo '🔐 Autenticando en Safety Cloud...' &&
                                safety auth login --api-key \$SAFETY_API_KEY &&
                                if [ -f requirements.txt ]; then
                                    echo '📄 Instalando dependencias del proyecto...';
                                    pip install -q -r requirements.txt;
                                else
                                    echo '⚠️ No se encontró requirements.txt, creando uno temporal...';
                                    echo 'flask==2.0.1' > requirements.txt;
                                fi &&
                                echo '🚀 Ejecutando análisis con Safety y subiendo resultados...' &&
                                safety check --project 'Jenkins Safety Scan' --upload --output json --file=requirements.txt > safety.json || true
                            "

                        mv safety.json ${REPORT_DIR}/safety.json || echo '⚠️ No se generó safety.json'
                    '''

                    echo "✅ Reporte Safety generado en: ${REPORT_DIR}/safety.json"
                    sh 'ls -l ${REPORT_DIR} || true'
                }
            }
        }

        stage('Compilation') {
            steps {
                echo "⚙️ Compilando aplicación..."
                sh 'sleep 1'
            }
        }

        stage('Build') {
            steps {
                echo "🏗️ Construyendo imagen Docker..."
                sh 'echo "docker build -t my-php-app ."'
            }
        }

        stage('Deploy') {
            steps {
                echo "🚀 Desplegando contenedor..."
                sh 'echo "docker run my-php-app"'
            }
        }
    }

    post {
        always {
            echo "📦 Archivando artefactos..."
            archiveArtifacts artifacts: 'reports/safety.json', fingerprint: true, allowEmptyArchive: true
        }
        success {
            echo "✅ Pipeline completado correctamente."
        }
        unstable {
            echo "⚠️ Pipeline marcado como inestable por vulnerabilidades detectadas."
        }
        failure {
            echo "❌ Pipeline fallido."
        }
    }
}
