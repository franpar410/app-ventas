pipeline {
    agent any

    environment {
        REPORT_DIR = "${WORKSPACE}/reports"
        SAFETY_API_KEY = credentials('safety-api-key') // ID del token en Jenkins Credentials
    }

    stages {

        stage('SCA - Safety Security Scan') {
            steps {
                script {
                    echo "ğŸ” Ejecutando anÃ¡lisis de dependencias con Safety (Docker + API)..."

                    sh '''
                        set -e
                        mkdir -p ${REPORT_DIR}

                        echo "ğŸ“¦ Lanzando contenedor Python para anÃ¡lisis..."
                        docker run --rm \
                            -e SAFETY_API_KEY=${SAFETY_API_KEY} \
                            -v "$PWD":/app \
                            -w /app \
                            python:3.11-slim bash -c "
                                set -e
                                apt-get update -qq &&
                                apt-get install -y --no-install-recommends gcc libpq-dev jq > /dev/null &&
                                pip install -q safety &&
                                echo 'ğŸ” Autenticando en Safety Cloud...' &&
                                safety auth login --api-key \$SAFETY_API_KEY &&
                                if [ -f requirements.txt ]; then
                                    echo 'ğŸ“„ Instalando dependencias del proyecto...';
                                    pip install -q -r requirements.txt;
                                else
                                    echo 'âš ï¸ No se encontrÃ³ requirements.txt, creando uno temporal...';
                                    echo 'flask==2.0.1' > requirements.txt;
                                fi &&
                                echo 'ğŸš€ Ejecutando anÃ¡lisis con Safety y subiendo resultados...' &&
                                safety check --project 'Jenkins Safety Scan' --upload --output json --file=requirements.txt > safety.json || true
                            "

                        mv safety.json ${REPORT_DIR}/safety.json || echo 'âš ï¸ No se generÃ³ safety.json'
                    '''

                    echo "âœ… Reporte Safety generado en: ${REPORT_DIR}/safety.json"
                    sh 'ls -l ${REPORT_DIR} || true'
                }
            }
        }

        stage('Compilation') {
            steps {
                echo "âš™ï¸ Compilando aplicaciÃ³n..."
                sh 'sleep 1'
            }
        }

        stage('Build') {
            steps {
                echo "ğŸ—ï¸ Construyendo imagen Docker..."
                sh 'echo "docker build -t my-php-app ."'
            }
        }

        stage('Deploy') {
            steps {
                echo "ğŸš€ Desplegando contenedor..."
                sh 'echo "docker run my-php-app"'
            }
        }
    }

    post {
        always {
            echo "ğŸ“¦ Archivando artefactos..."
            archiveArtifacts artifacts: 'reports/safety.json', fingerprint: true, allowEmptyArchive: true
        }
        success {
            echo "âœ… Pipeline completado correctamente."
        }
        unstable {
            echo "âš ï¸ Pipeline marcado como inestable por vulnerabilidades detectadas."
        }
        failure {
            echo "âŒ Pipeline fallido."
        }
    }
}
