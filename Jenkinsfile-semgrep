
pipeline {
    agent any

    triggers {
        githubPush()
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/franpar410/app-ventas.git'
            }
        }

        stage('Setup Python Environment') {
            agent any
            steps {
                sh '''
                    docker run --rm -v $PWD:/src -w /src python:3.11 bash -c "
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install -r requirements.txt || echo 'No requirements.txt'
                    "
                '''
            }
        }

        stage('Build') {
            steps {
                echo 'Este es un build de prueba'
                sh 'echo "Hola desde Jenkins!"'
            }
        }

        /* ------------------------------ */
        /* üîç Static Code Analysis (Semgrep) */
        /* ------------------------------ */
        stage('Static Code Analysis (Semgrep)') {
            agent {
                docker {
                    image 'returntocorp/semgrep:latest'   // Imagen oficial de Semgrep
                    args '-v $WORKSPACE:/src'             // Monta el workspace en el contenedor
                }
            }

            steps {
                script {
                    sh '''
                        echo "üì¶ Ejecutando an√°lisis est√°tico con Semgrep dentro de contenedor Docker..."

                        # Crear carpeta de reportes en la ruta del workspace
                        mkdir -p $WORKSPACE/reports
                        cd /src
                        
                        # Ejecutar an√°lisis y generar reportes
                        semgrep --config auto --json --output $WORKSPACE/reports/semgrep-report.json || true
                        semgrep --config auto --sarif --output $WORKSPACE/reports/semgrep-report.sarif || true
                    '''
                }
            }

            post {
                always {
                    echo 'üìÑ Archivando reportes de Semgrep...'
                    archiveArtifacts artifacts: 'reports/*.json, reports/*.sarif', fingerprint: true, allowEmptyArchive: true
                }
                failure {
                    echo '‚ùå Semgrep encontr√≥ vulnerabilidades cr√≠ticas.'
                }
            }
        }

        stage('Push to Registry (optional)') {
            when {
                expression { return false }
            }
            steps {
                sh 'echo "Pushing to Docker Registry..."'
            }
        }

        stage('Deploy') {
            steps {
                sh 'echo "Deploying to environment..."'
            }
        }
    }

    post {
        always {
            echo 'Pipeline finalizado.'
        }
    }
}
