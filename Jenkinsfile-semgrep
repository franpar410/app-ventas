pipeline {
    agent any

    triggers {
        githubPush()
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/franpar410/app-ventas.git'
            }
        }

    stage('Setup Python Environment') {
        agent any
        steps {
            sh '''
                docker run --rm -v $PWD:/src -w /src python:3.11 bash -c "
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install -r requirements.txt || echo 'No requirements.txt'
                "
            '''
        }
    }


        stage('Build') {
            steps {
                echo 'Este es un build de prueba'
                sh 'echo "Hola desde Jenkins!"'
            }
        }

        /* ------------------------------ */
        /* üîç Nuevo Stage: SEMGREP en Docker */
        /* ------------------------------ */
        stage('Static Code Analysis (Semgrep)') {
            agent {
                docker {
                    image 'returntocorp/semgrep:latest'   // Imagen oficial de Semgrep
                    args '-v $WORKSPACE:/src'             // Monta el workspace de Jenkins en /src
                }
            }

            steps {
                script {
                    sh '''
                        echo "üì¶ Ejecutando an√°lisis est√°tico con Semgrep dentro de contenedor Docker..."
                        mkdir -p reports
                        cd /src
                        
                        # Ejecutar an√°lisis
                        semgrep --config auto --json > reports/semgrep-report.json || true
                        semgrep --config auto --sarif > reports/semgrep-report.sarif || true
                    '''
                }
            }


            post {
                always {
                    echo 'üìÑ Archivando reportes de Semgrep...'
                    archiveArtifacts artifacts: 'reports/*.json, reports/*.sarif', fingerprint: true
                }
                failure {
                    echo '‚ùå Semgrep encontr√≥ vulnerabilidades cr√≠ticas.'
                }
            }
        }

        stage('Push to Registry (optional)') {
            when {
                expression { return false }
            }
            steps {
                sh 'echo "Pushing to Docker Registry..."'
            }
        }

        stage('Deploy') {
            steps {
                sh 'echo "Deploying to environment..."'
            }
        }
    }

    post {
        always {
            echo 'Pipeline finalizado.'
        }
    }
}
